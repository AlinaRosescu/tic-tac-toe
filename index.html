<!DOCTYPE html>
<html>
	<head>
		<title>Tic-Tac-Toe</title>
		<meta charset="UTF-8">
      <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Sriracha" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="styles.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	</head>
	<body>
      <div class="container">
         <h1>Tic Tac Toe</h1>
         <h2>Do you wanna play a game?</h2>
         <button name="start" type="button" id="start">Start game</button>
         <button name="restart" type="button" id="restart">Restart game</button>
         <div id="grid">
         </div>
         <div class="result">
         </div>
      </div>

	<script rel="javascript">
      var game = false;
      var status;
      var currentPlayer;
      var divId;
      var round;
      var result;
      var gameGrid = [];
      var updatedWinCases;
      var winCases = [];
      var chosenDiv;
      var isAvailable = false;

      //start game
      $(".container").on("click", "button", startGame);

      //initialize variables and add click event on grid
      function startGame() {
         game = true;
         round = 1;
         status = "playing";
         winCases = [
            ["0","1","2"],
            ["3","4","5"],
            ["6","7","8"],
            ["0","3","6"],
            ["1","4","7"],
            ["2","5","8"],
            ["2","4","6"],
            ["0","4","8"]
         ];
         createGrid();

         for (let i = 1; i <= 5; i++) {
            if (game !== false) {
               movePlayer1();
            }
         }
      }

      //create game 3x3 grid and set array with value E from empty
      function createGrid() {
         if ($("#grid").children("div").length > 0) {
            $("#grid").empty();
            $(".result").empty();
         }

         $("#grid").css("display", "block");
         $("#start").css("display", "none");
         $("#restart").css("display", "block");
         for (let i = 0; i < 9; i++) {
            var square = document.createElement("div");
            document.getElementById("grid").appendChild(square);
            square.id = i;
            gameGrid[i] = "E";
         }
      }

      // register user clicks and moves
      function movePlayer1() {
         $("#grid").on("click", "div", function() {
            currentPlayer = "X";
            if (!($(this).attr("disabled"))) {
               $(this).html("<p>X</p>");
               $(this).css("color", "#09958d");
               $(this).attr("disabled", "true");
               divId = $(this).attr("id");
               gameGrid[divId] = "X";

               updatedWinCases = winCases.map(updateWinCases);
               checkResults(currentPlayer);

               if (status !== "over") {
                  movePlayer2(divId);
               }
            }
         });
      }

      //make computer moves
      function movePlayer2(userMove) {
         var userChoice = parseInt(userMove);
         currentPlayer = "O";

         switch(round) {
            case 1:
               if (userChoice !== 4) {
                  divId = 4;
                  checkIsDivAvailable(divId);
               } else if (userChoice === 4) {
                  do {
                     var randomId = Math.floor(Math.random() * (8 - 0 + 1)) + 0;
                     if (randomId !== 4 && randomId % 2 === 0) {
                        divId = randomId;
                        checkIsDivAvailable(divId);
                        break;
                     }
                  } while (randomId === 4 || randomId % 2 !== 0);
               }
               break;
            case 2:
            case 3:
            case 4:
               var one = "X";
               var two = "O";
               var block =  false;
               var win = false;
               var divIdBlock;
               var divIdWin;

               //go through the updated win cases twice
               for (let i = 1; i < 3; i++) {
                  updatedWinCases.forEach(function (element) {
                     if (element[0] === one) {
                        if (element[1] === one &&  element[2] !== two) {
                           divId = element[2];
                        } else if (element[2] === one &&  element[1] !== two) {
                           divId = element[1];
                        }
                     } else if (element[1] === one) {
                        if (element[2] === one &&  element[0] !== two) {
                           divId = element[0];
                        }
                     }
                  })

                  //check if either X or O is about to win
                  if (one === "X") {
                     block = true;
                     divIdBlock = divId;
                     checkIsDivAvailable(divIdBlock);
                  } else if (one === "O") {
                     win = true;
                     divIdWin = divId;
                     checkIsDivAvailable(divIdWin);
                  }
                  var one = "O";
                  var two = "X";
               }

               //if both have a chance to win choose to win else choose to block
               if (win === true) {
                  chosenDiv = $(document.getElementById(divIdWin));
               } else if (block === true){
                  chosenDiv = $(document.getElementById(divIdBlock));
               }

               //if neither have a chance to win place O in the first available div
               if (!isAvailable)  {
                  do {
                     updatedWinCases.forEach(function (element) {
                        for (let i = 0; i < element.length; i++) {
                           if (element[i] !== one && element[i] !== two) {
                              divId = element[i];
                              checkIsDivAvailable(divId);
                              break;
                           }
                        }
                     })
                  } while(!isAvailable);
               }
               break;
         }//close switch

         //select div where to add O
         chosenDiv.html("<p>0</p>").delay(800);
         chosenDiv.css("color", "#fc2c54");
         chosenDiv.attr("disabled", "true");
         gameGrid[divId] = "O";
         round++;
         updatedWinCases = winCases.map(updateWinCases);
         checkResults(currentPlayer);
      }

      // check if selected div is available
      function checkIsDivAvailable(div) {
         chosenDiv = $(document.getElementById(div));
         if (!(chosenDiv.attr("disabled"))) {
            isAvailable = true;
         } else {
            isAvailable = false;
         }
         return isAvailable;
      }


      //update the win case array with player's moves
      function updateWinCases(item) {
         for (let i = 0; i < item.length; i++) {
            if (item[i] == divId) {
               item[i] = currentPlayer;
            }
         }
         return item;
      }

      //check if either player has won, the game ends in a draw or game is still going
      function checkResults(player) {
         updatedWinCases.forEach(function (element) {
            if (element[0] === player && element[1] === player && element[2] === player) {
               endGame(player);
            }
         })

         for (let i = 0; i < gameGrid.length; i++) {
            if (gameGrid[i] === "E") {
               game = true;
               break;
            } else if (gameGrid[i] !== "E" && i === 8) {
               endGame("It's a draw");
            }
         }
      }


      //if game has ended alert the user of the result
      function endGame(result) {
         game = false;
         status = "over";

         $("#grid").off("click", "div");
         if (result === "X" || result === "O") {
            if (result === "X") {
               $(".result").css("color", "#09958d");
            } else if (result === "O") {
               $(".result").css("color", "#fc2c54");
            }
            $(".result").append("<p>" + result +" has won!</p>");
         } else {
            $(".result").append("<p>" + result + "</p>");
            $(".result").css("color", "#076762");
         }
      }


	</script>
	</body>
</html>




